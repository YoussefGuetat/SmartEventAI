pipeline {
    agent any

    parameters {
        string(name: 'CI_BUILD_NUMBER', defaultValue: '39', description: 'Build number from CI')
        string(name: 'DOCKER_TAG', defaultValue: 'latest', description: 'Docker tag to deploy')
        password(name: 'POSTGRES_PASSWORD', defaultValue: '', description: 'PostgreSQL password for AlwaysData')
    }

    environment {
        DOCKERHUB_NAMESPACE = 'guetatyoussef'
        
        // AlwaysData Configuration
        ALWAYSDATA_USER = 'dztn'
        ALWAYSDATA_HOST = 'ssh-dztn.alwaysdata.net'
        ALWAYSDATA_DEPLOY_DIR = '~/auth-service'
        
        // PostgreSQL Configuration (from AlwaysData)
        POSTGRES_HOST = 'postgresql-dztn.alwaysdata.net'
        POSTGRES_PORT = '5432'
        POSTGRES_DB = 'dztn_smartevent'
        POSTGRES_USER = 'dztn'
    }

    stages {
        stage('Initialize Deployment') {
            steps {
                script {
                    echo "=========================================="
                    echo "  SmartEvent AI - CD Pipeline"
                    echo "  Deploying to AlwaysData"
                    echo "  Build #${params.CI_BUILD_NUMBER}"
                    echo "  Docker Tag: ${params.DOCKER_TAG}"
                    echo "=========================================="
                }
            }
        }

        stage('Download JAR from CI') {
            steps {
                script {
                    echo "ðŸ“¥ Getting auth-service JAR from CI build #${params.CI_BUILD_NUMBER}..."
                    
                    try {
                        def artifactPath = "/var/lib/jenkins/jobs/SmartEventAI-CI/builds/${params.CI_BUILD_NUMBER}/archive"
                        
                        sh """
                            echo "Looking for JAR in archived artifacts..."
                            ls -la ${artifactPath}/
                            
                            if [ -f ${artifactPath}/target/auth-service-0.0.1-SNAPSHOT.jar ]; then
                                echo "âœ… Found JAR in target directory"
                                cp ${artifactPath}/target/auth-service-0.0.1-SNAPSHOT.jar auth-service.jar
                            elif [ -f ${artifactPath}/auth-service-0.0.1-SNAPSHOT.jar ]; then
                                echo "âœ… Found JAR at root"
                                cp ${artifactPath}/auth-service-0.0.1-SNAPSHOT.jar auth-service.jar
                            else
                                echo "âŒ JAR not found"
                                echo "Archive contents:"
                                find ${artifactPath} -name "*.jar" -type f
                                exit 1
                            fi
                            
                            if [ ! -f auth-service.jar ]; then
                                echo "âŒ Failed to obtain JAR file"
                                exit 1
                            fi
                            
                            echo "âœ… JAR obtained successfully:"
                            ls -lh auth-service.jar
                            file auth-service.jar
                        """
                        
                        echo "âœ… JAR downloaded successfully"
                        
                    } catch (Exception e) {
                        echo "âŒ Failed to get JAR: ${e.message}"
                        error("Failed to obtain JAR file from CI build #${params.CI_BUILD_NUMBER}")
                    }
                }
            }
        }

        stage('Prepare Configuration Files') {
            steps {
                script {
                    echo "ðŸ“ Creating configuration files..."
                    
                    writeFile file: 'application.properties', text: """
# Server Configuration
server.port=8081

# PostgreSQL Configuration
spring.datasource.url=jdbc:postgresql://${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}
spring.datasource.username=${POSTGRES_USER}
spring.datasource.password=${params.POSTGRES_PASSWORD}
spring.datasource.driver-class-name=org.postgresql.Driver

# JPA/Hibernate
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=false
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect
spring.jpa.properties.hibernate.format_sql=true

# Logging
logging.level.org.springframework=INFO
logging.level.com.smartevent=DEBUG
logging.file.name=auth-service.log

# Actuator
management.endpoints.web.exposure.include=health,info,metrics
management.endpoint.health.show-details=always
"""
                    
                    writeFile file: 'manage-auth.sh', text: '''#!/bin/bash

PID_FILE="auth-service.pid"
JAR_FILE="auth-service.jar"
LOG_FILE="auth-service.log"
CONFIG_FILE="application.properties"

case "$1" in
  start)
    echo "ðŸš€ Starting auth-service..."
    if [ -f $PID_FILE ] && ps -p $(cat $PID_FILE) > /dev/null 2>&1; then
      echo "âš ï¸  auth-service is already running (PID: $(cat $PID_FILE))"
      exit 1
    fi
    nohup java -jar $JAR_FILE --spring.config.location=$CONFIG_FILE > $LOG_FILE 2>&1 &
    echo $! > $PID_FILE
    echo "âœ… auth-service started (PID: $(cat $PID_FILE))"
    sleep 3
    tail -n 20 $LOG_FILE
    ;;
    
  stop)
    echo "ðŸ›‘ Stopping auth-service..."
    if [ -f $PID_FILE ]; then
      PID=$(cat $PID_FILE)
      kill $PID 2>/dev/null
      rm $PID_FILE
      echo "âœ… auth-service stopped"
    else
      echo "âš ï¸  PID file not found, killing all auth-service processes"
      pkill -f auth-service.jar
    fi
    ;;
    
  restart)
    $0 stop
    sleep 3
    $0 start
    ;;
    
  status)
    if [ -f $PID_FILE ]; then
      PID=$(cat $PID_FILE)
      if ps -p $PID > /dev/null 2>&1; then
        echo "âœ… auth-service is running (PID: $PID)"
        echo ""
        echo "ðŸ“Š Memory usage:"
        ps -p $PID -o pid,vsz,rss,comm
      else
        echo "âŒ auth-service is not running (stale PID file)"
        rm $PID_FILE
      fi
    else
      echo "âŒ auth-service is not running"
    fi
    ;;
    
  logs)
    if [ "$2" = "follow" ] || [ "$2" = "f" ]; then
      tail -f $LOG_FILE
    else
      tail -n 100 $LOG_FILE
    fi
    ;;
    
  health)
    echo "ðŸ¥ Checking health endpoint..."
    curl -s http://localhost:8081/actuator/health | python3 -m json.tool 2>/dev/null || curl http://localhost:8081/actuator/health
    ;;
    
  *)
    echo "Usage: $0 {start|stop|restart|status|logs [follow]|health}"
    exit 1
    ;;
esac
'''
                    
                    sh 'chmod +x manage-auth.sh'
                    
                    echo "âœ… Configuration files created"
                }
            }
        }

        stage('Install sshpass') {
            steps {
                script {
                    echo "ðŸ“¦ Checking sshpass installation..."
                    sh '''
                        if ! which sshpass > /dev/null 2>&1; then
                            echo "Installing sshpass..."
                            sudo apt-get update -qq
                            sudo apt-get install -y sshpass
                        else
                            echo "âœ… sshpass already installed"
                        fi
                    '''
                }
            }
        }

        stage('Transfer Files to AlwaysData') {
            steps {
                script {
                    echo "ðŸ“¤ Transferring files to AlwaysData..."
                    
                    withCredentials([usernamePassword(credentialsId: 'alwaysdata-credentials', usernameVariable: 'SSH_USER', passwordVariable: 'SSH_PASS')]) {
                        sh """
                            # CrÃ©er le rÃ©pertoire sur AlwaysData
                            echo "Creating directory on AlwaysData..."
                            sshpass -p "\${SSH_PASS}" ssh -o StrictHostKeyChecking=no ${ALWAYSDATA_USER}@${ALWAYSDATA_HOST} "mkdir -p ${ALWAYSDATA_DEPLOY_DIR}"
                            
                            # TransfÃ©rer les fichiers
                            echo "Transferring auth-service.jar..."
                            sshpass -p "\${SSH_PASS}" scp -o StrictHostKeyChecking=no auth-service.jar ${ALWAYSDATA_USER}@${ALWAYSDATA_HOST}:${ALWAYSDATA_DEPLOY_DIR}/
                            
                            echo "Transferring application.properties..."
                            sshpass -p "\${SSH_PASS}" scp -o StrictHostKeyChecking=no application.properties ${ALWAYSDATA_USER}@${ALWAYSDATA_HOST}:${ALWAYSDATA_DEPLOY_DIR}/
                            
                            echo "Transferring manage-auth.sh..."
                            sshpass -p "\${SSH_PASS}" scp -o StrictHostKeyChecking=no manage-auth.sh ${ALWAYSDATA_USER}@${ALWAYSDATA_HOST}:${ALWAYSDATA_DEPLOY_DIR}/
                            
                            echo "âœ… All files transferred successfully"
                        """
                    }
                }
            }
        }

        stage('Deploy on AlwaysData') {
            steps {
                script {
                    echo "ðŸš€ Deploying auth-service on AlwaysData..."
                    
                    withCredentials([usernamePassword(credentialsId: 'alwaysdata-credentials', usernameVariable: 'SSH_USER', passwordVariable: 'SSH_PASS')]) {
                        sh """
                            sshpass -p "\${SSH_PASS}" ssh -o StrictHostKeyChecking=no ${ALWAYSDATA_USER}@${ALWAYSDATA_HOST} << 'ENDSSH'
                                cd ${ALWAYSDATA_DEPLOY_DIR}
                                
                                echo "ðŸ“‹ Current directory contents:"
                                ls -lh
                                
                                echo ""
                                echo "ðŸ›‘ Stopping old service..."
                                ./manage-auth.sh stop || true
                                
                                echo ""
                                echo "â³ Waiting 3 seconds..."
                                sleep 3
                                
                                echo ""
                                echo "ðŸš€ Starting new service..."
                                ./manage-auth.sh start
                                
                                echo ""
                                echo "â³ Waiting 10 seconds for startup..."
                                sleep 10
                                
                                echo ""
                                echo "ðŸ“Š Checking service status..."
                                ./manage-auth.sh status
ENDSSH
                        """
                    }
                    
                    echo "âœ… Deployment completed"
                }
            }
        }

        stage('Health Check') {
            steps {
                script {
                    echo "ðŸ¥ Running health checks..."
                    
                    withCredentials([usernamePassword(credentialsId: 'alwaysdata-credentials', usernameVariable: 'SSH_USER', passwordVariable: 'SSH_PASS')]) {
                        sh """
                            sshpass -p "\${SSH_PASS}" ssh -o StrictHostKeyChecking=no ${ALWAYSDATA_USER}@${ALWAYSDATA_HOST} << 'ENDSSH'
                                cd ${ALWAYSDATA_DEPLOY_DIR}
                                
                                echo "=========================================="
                                echo "Service Status:"
                                echo "=========================================="
                                ./manage-auth.sh status
                                
                                echo ""
                                echo "=========================================="
                                echo "Health Check:"
                                echo "=========================================="
                                ./manage-auth.sh health
                                
                                echo ""
                                echo "=========================================="
                                echo "Recent Logs (last 30 lines):"
                                echo "=========================================="
                                tail -n 30 auth-service.log
ENDSSH
                        """
                    }
                    
                    echo "âœ… Health checks completed"
                }
            }
        }

        stage('Generate Deployment Report') {
            steps {
                script {
                    echo "ðŸ“Š Generating deployment report..."
                    
                    def report = """
========================================
SmartEvent AI - Deployment Report
========================================

Build Number: ${params.CI_BUILD_NUMBER}
Docker Tag: ${params.DOCKER_TAG}
Deployment Date: ${new Date()}

========================================
DEPLOYMENT TARGET: AlwaysData
========================================

Server: ${ALWAYSDATA_HOST}
User: ${ALWAYSDATA_USER}
Directory: ${ALWAYSDATA_DEPLOY_DIR}

Database: ${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}

========================================
SERVICE DEPLOYED:
========================================

âœ… auth-service
   - Port: 8081
   - Status: Running
   - Health: http://localhost:8081/actuator/health

========================================
ACCESS & MANAGEMENT:
========================================

SSH Access:
  ssh ${ALWAYSDATA_USER}@${ALWAYSDATA_HOST}
  cd ${ALWAYSDATA_DEPLOY_DIR}

Management Commands:
  ./manage-auth.sh start       # Start service
  ./manage-auth.sh stop        # Stop service
  ./manage-auth.sh restart     # Restart service
  ./manage-auth.sh status      # Check status
  ./manage-auth.sh logs        # View logs
  ./manage-auth.sh logs follow # Follow logs
  ./manage-auth.sh health      # Health check

========================================
âœ… Deployment completed successfully!
========================================
"""
                    
                    echo report
                    
                    writeFile file: "deployment-report-${params.CI_BUILD_NUMBER}.txt", text: report
                    archiveArtifacts artifacts: "deployment-report-${params.CI_BUILD_NUMBER}.txt", allowEmptyArchive: true
                    
                    echo "âœ… Report generated and archived"
                }
            }
        }
    }

    post {
        success {
            script {
                echo ""
                echo "âœ… =========================================="
                echo "âœ… DEPLOYMENT SUCCESSFUL!"
                echo "âœ… =========================================="
                echo "âœ… auth-service deployed on AlwaysData"
                echo "âœ… Service running on port 8081"
                echo "âœ… Access: ssh ${ALWAYSDATA_USER}@${ALWAYSDATA_HOST}"
                echo "âœ… =========================================="
                echo ""
            }
        }
        failure {
            script {
                echo ""
                echo "âŒ =========================================="
                echo "âŒ DEPLOYMENT FAILED!"
                echo "âŒ =========================================="
                echo "âŒ Check the logs above for details"
                echo "âŒ Manual check:"
                echo "âŒ   ssh ${ALWAYSDATA_USER}@${ALWAYSDATA_HOST}"
                echo "âŒ   cd ${ALWAYSDATA_DEPLOY_DIR}"
                echo "âŒ   ./manage-auth.sh logs"
                echo "âŒ =========================================="
                echo ""
            }
        }
        always {
            script {
                echo "ðŸ§¹ Cleaning up workspace..."
                sh '''
                    rm -f auth-service.jar
                    rm -f application.properties
                    rm -f manage-auth.sh
                '''
            }
        }
    }
}
